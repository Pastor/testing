<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <title>Editor</title>
    <style type="text/css" media="screen">
        body {
            overflow: hidden;
        }

        #editor {
            margin: 0;
            /*position: absolute;*/
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body>

<pre id="editor">
#include &lt;tcclib.h&gt;
#ifdef _WIN32                           /* dynamically linked data needs 'dllimport' */
 __attribute__((dllimport))
#endif
extern const char hello_text[];
extern void usleep(long ms);
int main(int argc, char **argv) {
    int i;

    for (i = 0; i &lt; 100; ++i ) {
        printf("%s: %d\n", hello_text, i);
        usleep(100);
    }
    return 3;
}
</pre>
<button onclick="send()">Send</button>

<script src="editor/ace.js" type="text/javascript" charset="utf-8"></script>
<script>
    const editor = ace.edit("editor");
    editor.setTheme("ace/theme/xcode");
    editor.session.setMode("ace/mode/c_cpp");
    editor.setOptions({
        maxLines: 25
    });

    function output(cb, msg) {
        let lines = msg.split("\r\n");
        for (let i = 0; i < lines.length; i++) {
            cb(lines[i]);
        }
    }

    function send() {
        const xhr = new XMLHttpRequest();
        let last_index = 0;
        xhr.open("POST", "/execute", true);
        xhr.setRequestHeader('Content-Type', 'text/plain; charset=UTF-8');

        function receive_chunk() {
            const curr_index = xhr.responseText.length;
            if (last_index === curr_index)
                return;
            const chunk = xhr.responseText.substring(last_index, curr_index);
            last_index = curr_index;

            switch (chunk.charAt(0)) {
                case '2':
                    output(console.error, chunk.substr(1));
                    break;
                case '1':
                    output(console.info, chunk.substr(1));
                    break;
                default:
                    output(console.warn, chunk);
                    break;
            }
        }

        xhr.onprogress = function (event) {
            receive_chunk();
        };
        // xhr.onreadystatechange = function () {
        //     if (xhr.readyState === 4) {
        //         console.log(xhr.responseText);
        //     }
        // console.debug(xhr.responseText);
        // };
        xhr.send(editor.getValue());
        //
        // const interval = setInterval(receive_chunk, 5000);
        // setTimeout(function () {
        //     clearInterval(interval);
        //     receive_chunk();
        //     xhr.abort();
        // }, 25000);
    }
</script>

</body>
</html>
